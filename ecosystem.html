<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ğŸŒ¸ Flower Garden</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; }
    body { overflow:hidden; background:#87CEEB; font-family:'Nunito',sans-serif; user-select:none; }
    canvas { display:block; position:fixed; top:0; left:0; cursor:crosshair; }

    #toolbar {
      position:fixed; bottom:0; left:0; right:0; z-index:20;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border-top:3px solid #c8e0f8;
      padding:8px 10px;
      display:flex; align-items:center; gap:7px;
      flex-wrap:wrap; justify-content:center;
    }
    .tbtn {
      padding:7px 13px; border:3px solid #ddd; border-radius:30px;
      background:white; cursor:pointer;
      font-family:'Nunito',sans-serif; font-size:0.85rem; font-weight:800;
      transition:all 0.15s; white-space:nowrap; line-height:1;
    }
    .tbtn.active { border-color:#1B6CA8; background:#1B6CA8; color:white; }
    .tbtn:hover { transform:translateY(-2px); box-shadow:0 4px 10px rgba(0,0,0,0.18); }
    .tbtn.rain { background:#29B6F6; color:white; border-color:#0288D1; }
    .tbtn.rain.on { background:#1565C0; border-color:#0D47A1; }
    .tbtn.clr  { background:#EF5350; color:white; border-color:#C62828; }
    .sep { color:#ccc; font-weight:900; font-size:1.1rem; }

    #hint {
      position:fixed; top:12px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.92); padding:7px 18px; border-radius:30px;
      font-weight:800; color:#1B6CA8; font-size:0.92rem; pointer-events:none;
      box-shadow:0 2px 14px rgba(0,0,0,0.13); white-space:nowrap; z-index:20;
    }
    #stats {
      position:fixed; top:12px; right:14px; z-index:20;
      background:rgba(255,255,255,0.92); padding:7px 14px; border-radius:20px;
      font-weight:800; color:#1B6CA8; font-size:0.82rem;
      box-shadow:0 2px 14px rgba(0,0,0,0.13);
    }
  </style>
</head>
<body>

<canvas id="c"></canvas>

<div id="hint">ğŸŒ± Click on the ground to plant a flower!</div>
<div id="stats">ğŸŒ¸ 0 Â· ğŸ¦‹ 0 Â· ğŸ 0</div>

<div id="toolbar">
  <span style="font-weight:900;color:#777;font-size:0.8rem;">PLANT:</span>
  <button class="tbtn active" data-tool="daisy"      onclick="selectTool('daisy',this)">ğŸŒ¼ Daisy</button>
  <button class="tbtn"        data-tool="sunflower"  onclick="selectTool('sunflower',this)">ğŸŒ» Sunflower</button>
  <button class="tbtn"        data-tool="tulip"      onclick="selectTool('tulip',this)">ğŸŒ· Tulip</button>
  <button class="tbtn"        data-tool="wildflower" onclick="selectTool('wildflower',this)">ğŸ’œ Wildflower</button>
  <button class="tbtn"        data-tool="rose"       onclick="selectTool('rose',this)">ğŸŒ¹ Rose</button>
  <span class="sep">|</span>
  <button class="tbtn rain" id="rain-btn" onclick="toggleRain()">ğŸŒ§ï¸ Rain</button>
  <button class="tbtn clr"  onclick="clearAll()">ğŸ—‘ï¸ Clear</button>
</div>

<script>
'use strict';

// â”€â”€â”€ Canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('c');
const ctx    = canvas.getContext('2d');

let W, H, GROUND_Y, TB_H;

function resize() {
  W = canvas.width  = window.innerWidth;
  H = canvas.height = window.innerHeight;
  TB_H    = document.getElementById('toolbar').offsetHeight || 64;
  GROUND_Y = H - TB_H - 80;
}
window.addEventListener('resize', () => { resize(); initClouds(); });
resize();

// â”€â”€â”€ Flower definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFS = {
  daisy: {
    petalN:12, petalLen:22, petalW:9,
    pColors:['#FFFFFF','#FFFDE7','#E8F5E9'],
    cColors:['#FFD700','#FFC107'],
    stemH:80, leafW:18, bloomAge:250,
  },
  sunflower: {
    petalN:18, petalLen:36, petalW:15,
    pColors:['#FFD700','#FFC107','#FFCA28'],
    cColors:['#5D4037','#4E342E'],
    stemH:130, leafW:30, bloomAge:320,
  },
  tulip: {
    petalN:6, petalLen:33, petalW:20,
    pColors:['#F06292','#E91E63','#FF1493','#EF9A9A','#CE93D8'],
    cColors:['#FCE4EC','#F8BBD0'],
    stemH:95, leafW:22, bloomAge:260,
  },
  wildflower: {
    petalN:9, petalLen:16, petalW:7,
    pColors:['#9C27B0','#7B1FA2','#AB47BC','#7E57C2','#5E35B1'],
    cColors:['#FFE082','#FFD54F'],
    stemH:65, leafW:14, bloomAge:200,
  },
  rose: {
    petalN:5, petalLen:28, petalW:18,
    pColors:['#E53935','#C62828','#EF5350','#E57373','#D32F2F'],
    cColors:['#B71C1C','#C62828'],
    stemH:105, leafW:24, bloomAge:300,
  },
};

// â”€â”€â”€ Stage thresholds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S0 = 60;   // seed â†’ sprout
const S1 = 150;  // sprout â†’ bud
const S2 = 280;  // bud â†’ bloom

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let flowers     = [];
let butterflies = [];
let bees        = [];
let raindrops   = [];
let particles   = [];
let clouds      = [];
let selectedTool = 'daisy';
let isRaining    = false;
let tick         = 0;

// â”€â”€â”€ Clouds init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initClouds() {
  clouds = [];
  for (let i = 0; i < 6; i++) {
    clouds.push(makeCloud(Math.random() * W));
  }
}
function makeCloud(x) {
  return {
    x,
    y: 30 + Math.random() * (GROUND_Y * 0.38),
    scale: 0.45 + Math.random() * 0.85,
    speed: 0.12 + Math.random() * 0.28,
    alpha: 0.55 + Math.random() * 0.4,
  };
}
initClouds();

// â”€â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectTool(tool, btn) {
  selectedTool = tool;
  document.querySelectorAll('.tbtn[data-tool]').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function toggleRain() {
  isRaining = !isRaining;
  const btn = document.getElementById('rain-btn');
  btn.textContent = isRaining ? 'â˜€ï¸ Stop Rain' : 'ğŸŒ§ï¸ Rain';
  btn.classList.toggle('on', isRaining);
}

function clearAll() {
  flowers = []; butterflies = []; bees = [];
  raindrops = []; particles = [];
}

// â”€â”€â”€ Plant flower â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function plantFlower(px) {
  if (flowers.length >= 60) return; // cap for performance
  const def = DEFS[selectedTool];
  const pColors = def.pColors;
  const cColors = def.cColors;
  flowers.push({
    x: px,
    y: GROUND_Y,
    type: selectedTool,
    def,
    stage: 0,
    age: 0,
    swayPhase: Math.random() * Math.PI * 2,
    swayAmp: 5 + Math.random() * 7,
    petalColor: pColors[Math.floor(Math.random() * pColors.length)],
    centerColor: cColors[Math.floor(Math.random() * cColors.length)],
    leafColor: ['#4CAF50','#388E3C','#66BB6A','#2E7D32'][Math.floor(Math.random()*4)],
    sparked: false,
  });
}

// â”€â”€â”€ Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('click', e => {
  const r = canvas.getBoundingClientRect();
  const cy = e.clientY - r.top;
  if (cy >= GROUND_Y - 30 && cy <= H - TB_H) {
    plantFlower(e.clientX - r.left);
  }
});
canvas.addEventListener('touchend', e => {
  e.preventDefault();
  const r  = canvas.getBoundingClientRect();
  const t  = e.changedTouches[0];
  const cy = t.clientY - r.top;
  if (cy >= GROUND_Y - 30 && cy <= H - TB_H) {
    plantFlower(t.clientX - r.left);
  }
}, { passive: false });

// â”€â”€â”€ Spawn helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BFLY_COLORS = ['#FF6B35','#FFD166','#EF476F','#06D6A0','#118AB2','#9B5DE5','#F15BB5','#FEE440'];

function spawnButterfly() {
  const left = Math.random() < 0.5;
  butterflies.push({
    x: left ? -35 : W + 35,
    y: 60 + Math.random() * (GROUND_Y * 0.65),
    vx: left ? 1.1 + Math.random() * 0.8 : -(1.1 + Math.random() * 0.8),
    vy: (Math.random() - 0.5) * 0.7,
    color: BFLY_COLORS[Math.floor(Math.random() * BFLY_COLORS.length)],
    wingPhase: Math.random() * Math.PI * 2,
    wingSpeed: 0.14 + Math.random() * 0.1,
    size: 0.7 + Math.random() * 0.5,
    state: 'wander',   // wander | seek | visit
    target: null,
    visitTimer: 0,
    orbitAngle: 0,
    idleTimer: 0,
    faceAngle: 0,
  });
}

function spawnBee() {
  const left = Math.random() < 0.5;
  bees.push({
    x: left ? -25 : W + 25,
    y: 80 + Math.random() * (GROUND_Y * 0.55),
    vx: left ? 1.4 + Math.random() * 0.6 : -(1.4 + Math.random() * 0.6),
    vy: (Math.random() - 0.5) * 0.5,
    wingPhase: Math.random() * Math.PI * 2,
    state: 'wander',
    target: null,
    visitTimer: 0,
    orbitAngle: 0,
    idleTimer: 0,
  });
}

// â”€â”€â”€ Bloom particles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bloomParticles(f) {
  const headY = f.y - f.def.stemH;
  for (let i = 0; i < 24; i++) {
    const a = Math.random() * Math.PI * 2;
    const sp = 1 + Math.random() * 3.5;
    particles.push({
      x: f.x, y: headY,
      vx: Math.cos(a) * sp,
      vy: Math.sin(a) * sp - 2.5,
      color: i < 14 ? f.petalColor : f.centerColor,
      alpha: 1,
      size: 3 + Math.random() * 5,
      gravity: 0.07,
    });
  }
}

// â”€â”€â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function update() {
  tick++;
  const wind = Math.sin(tick * 0.007) * 0.4;

  // Flowers
  const growRate = isRaining ? 2 : 1;
  for (const f of flowers) {
    f.age += growRate;
    const prev = f.stage;
    if      (f.age < S0) f.stage = 0;
    else if (f.age < S1) f.stage = 1;
    else if (f.age < S2) f.stage = 2;
    else                 f.stage = 3;
    if (prev < 3 && f.stage === 3 && !f.sparked) {
      f.sparked = true;
      bloomParticles(f);
    }
  }

  const bloomed = flowers.filter(f => f.stage === 3);

  // Spawn butterflies
  const maxBfly = Math.min(bloomed.length * 2 + 1, 10);
  if (butterflies.length < maxBfly && tick % 220 === 0) spawnButterfly();
  if (!isRaining && butterflies.length < 2 && tick % 360 === 0) spawnButterfly();

  // Update butterflies
  for (let i = butterflies.length - 1; i >= 0; i--) {
    const b = butterflies[i];
    b.wingPhase += b.wingSpeed;
    b.idleTimer++;

    if (b.state === 'wander') {
      b.vx += (Math.random() - 0.5) * 0.14 + wind * 0.18;
      b.vy += (Math.random() - 0.5) * 0.1;
      b.vx = clamp(b.vx, -2.4, 2.4);
      b.vy = clamp(b.vy, -1.8, 1.8);
      if (b.y > GROUND_Y - 60) b.vy -= 0.25;
      if (b.y < 50) b.vy += 0.2;
      if (bloomed.length && b.idleTimer > 100 && Math.random() < 0.018) {
        b.target = bloomed[Math.floor(Math.random() * bloomed.length)];
        b.state = 'seek';
      }
      if (b.idleTimer > 700 && (b.x < -70 || b.x > W + 70)) {
        butterflies.splice(i, 1); continue;
      }
      b.faceAngle = Math.atan2(b.vy, b.vx);
      b.x += b.vx; b.y += b.vy;
    }
    else if (b.state === 'seek') {
      if (!b.target || b.target.stage < 3) { b.state = 'wander'; b.target = null; continue; }
      const tx = b.target.x, ty = b.target.y - b.target.def.stemH - 28;
      const dx = tx - b.x, dy = ty - b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (dist < 40) { b.state = 'visit'; b.visitTimer = 0; b.orbitAngle = Math.atan2(b.y-ty, b.x-tx); continue; }
      b.vx += (dx/dist)*0.28; b.vy += (dy/dist)*0.28;
      b.vx = clamp(b.vx, -3, 3); b.vy = clamp(b.vy, -3, 3);
      b.faceAngle = Math.atan2(b.vy, b.vx);
      b.x += b.vx; b.y += b.vy;
    }
    else if (b.state === 'visit') {
      b.visitTimer++;
      if (!b.target || b.target.stage < 3) { b.state = 'wander'; b.target = null; continue; }
      b.orbitAngle += 0.034;
      const tx = b.target.x, ty = b.target.y - b.target.def.stemH - 18;
      const orR = 30 + Math.sin(b.visitTimer * 0.04) * 10;
      b.x += (tx + Math.cos(b.orbitAngle) * orR - b.x) * 0.1;
      b.y += (ty + Math.sin(b.orbitAngle) * orR * 0.4 - b.y) * 0.1;
      if (b.visitTimer > 160 + Math.random() * 100) {
        b.state = 'wander'; b.idleTimer = 0; b.target = null;
        b.vx = (Math.random()-0.5)*2; b.vy = -1;
      }
    }
  }

  // Spawn bees
  const maxBees = Math.min(bloomed.length, 5);
  if (bees.length < maxBees && tick % 280 === 0) spawnBee();

  // Update bees
  for (let i = bees.length - 1; i >= 0; i--) {
    const b = bees[i];
    b.wingPhase += 0.32;
    b.idleTimer++;

    if (b.state === 'wander') {
      b.vx += (Math.random()-0.5)*0.18 + wind*0.15;
      b.vy += (Math.random()-0.5)*0.12;
      b.vx = clamp(b.vx,-2,2); b.vy = clamp(b.vy,-1.5,1.5);
      if (b.y > GROUND_Y-55) b.vy -= 0.2;
      if (b.y < 55) b.vy += 0.2;
      if (bloomed.length && b.idleTimer > 80 && Math.random() < 0.022) {
        b.target = bloomed[Math.floor(Math.random()*bloomed.length)];
        b.state = 'seek';
      }
      if (b.idleTimer > 550 && (b.x < -60 || b.x > W+60)) { bees.splice(i,1); continue; }
      b.x += b.vx; b.y += b.vy;
    }
    else if (b.state === 'seek') {
      if (!b.target || b.target.stage < 3) { b.state='wander'; b.target=null; continue; }
      const tx=b.target.x, ty=b.target.y-b.target.def.stemH-14;
      const dx=tx-b.x, dy=ty-b.y, dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<28) { b.state='visit'; b.visitTimer=0; b.orbitAngle=Math.atan2(dy,dx); continue; }
      b.vx+=dx/dist*0.38; b.vy+=dy/dist*0.38;
      b.vx=clamp(b.vx,-3.5,3.5); b.vy=clamp(b.vy,-3.5,3.5);
      b.x+=b.vx; b.y+=b.vy;
    }
    else if (b.state === 'visit') {
      b.visitTimer++;
      if (!b.target || b.target.stage < 3) { b.state='wander'; b.target=null; continue; }
      b.orbitAngle += 0.065;
      const tx=b.target.x, ty=b.target.y-b.target.def.stemH-8;
      const orR = 18;
      b.x += (tx+Math.cos(b.orbitAngle)*orR - b.x)*0.14;
      b.y += (ty+Math.sin(b.orbitAngle)*orR*0.45 - b.y)*0.14;
      if (b.visitTimer > 90+Math.random()*70) { b.state='wander'; b.idleTimer=0; b.target=null; }
    }
  }

  // Rain
  if (isRaining) {
    for (let i=0; i<6; i++) {
      raindrops.push({
        x: Math.random()*W, y:-12,
        vy: 9+Math.random()*5, vx:-1.8,
        len: 14+Math.random()*14,
        alpha: 0.35+Math.random()*0.45,
      });
    }
  }
  for (let i=raindrops.length-1; i>=0; i--) {
    const d=raindrops[i];
    d.x+=d.vx; d.y+=d.vy;
    if (d.y > GROUND_Y+5 || d.x < -10) raindrops.splice(i,1);
  }

  // Particles
  for (let i=particles.length-1; i>=0; i--) {
    const p=particles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=p.gravity; p.alpha-=0.016;
    if (p.alpha<=0) particles.splice(i,1);
  }

  // Clouds
  const cloudSpeed = isRaining ? 2.2 : 1;
  for (const c of clouds) {
    c.x += c.speed * cloudSpeed;
    if (c.x > W+220) { c.x=-220; c.y=30+Math.random()*(GROUND_Y*0.38); }
  }

  // Stats
  const bl = flowers.filter(f=>f.stage===3).length;
  document.getElementById('stats').textContent =
    `ğŸŒ¸ ${flowers.length}(ğŸŒº${bl}) Â· ğŸ¦‹ ${butterflies.length} Â· ğŸ ${bees.length}`;
}

function clamp(v,lo,hi){ return v<lo?lo:v>hi?hi:v; }

// â”€â”€â”€ Draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function draw() {
  // Sky
  const sg = ctx.createLinearGradient(0,0,0,GROUND_Y);
  if (isRaining) {
    sg.addColorStop(0,'#4A6070'); sg.addColorStop(1,'#7A9BAB');
  } else {
    sg.addColorStop(0,'#5BB8F5'); sg.addColorStop(1,'#C8EAFF');
  }
  ctx.fillStyle=sg; ctx.fillRect(0,0,W,H);

  // Sun
  if (!isRaining) drawSun(W-90, 80);

  // Clouds
  for (const c of clouds) drawCloud(c.x, c.y, c.scale, c.alpha, isRaining);

  // Rain
  if (raindrops.length) {
    ctx.save();
    ctx.strokeStyle='#A5D8F0'; ctx.lineWidth=1.5;
    for (const d of raindrops) {
      ctx.globalAlpha=d.alpha;
      ctx.beginPath();
      ctx.moveTo(d.x, d.y);
      ctx.lineTo(d.x + d.vx*(d.len/d.vy), d.y - d.len*0.75);
      ctx.stroke();
    }
    ctx.globalAlpha=1; ctx.restore();
  }

  // Ground
  const gg = ctx.createLinearGradient(0,GROUND_Y,0,H);
  gg.addColorStop(0, isRaining ? '#5BA05B' : '#6DD46D');
  gg.addColorStop(0.25, '#55AE55');
  gg.addColorStop(1, '#3D8B3D');
  ctx.fillStyle=gg; ctx.fillRect(0,GROUND_Y,W,H-GROUND_Y);
  ctx.fillStyle = isRaining ? '#6ED06E' : '#80E080';
  ctx.fillRect(0,GROUND_Y,W,10);

  drawGrassTufts();

  // Flowers (back to front by x)
  const sf = [...flowers].sort((a,b)=>a.x-b.x);
  for (const f of sf) drawFlower(f);

  // Particles
  for (const p of particles) {
    ctx.save();
    ctx.globalAlpha=p.alpha;
    ctx.fillStyle=p.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    ctx.restore();
  }

  // Bees
  for (const b of bees) drawBee(b);

  // Butterflies
  for (const b of butterflies) drawButterfly(b);
}

// â”€â”€â”€ Draw: Sun â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawSun(x, y) {
  ctx.save();
  ctx.translate(x,y);
  // Glow
  const glow=ctx.createRadialGradient(0,0,0,0,0,60);
  glow.addColorStop(0,'rgba(255,230,50,0.45)');
  glow.addColorStop(1,'rgba(255,230,50,0)');
  ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(0,0,60,0,Math.PI*2); ctx.fill();
  // Rays
  ctx.rotate(tick*0.004);
  ctx.strokeStyle='rgba(255,215,0,0.55)'; ctx.lineWidth=3; ctx.lineCap='round';
  for (let i=0;i<12;i++) {
    const a=i/12*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(Math.cos(a)*44,Math.sin(a)*44);
    ctx.lineTo(Math.cos(a)*62,Math.sin(a)*62);
    ctx.stroke();
  }
  ctx.rotate(-tick*0.004);
  // Body
  ctx.fillStyle='#FFD700'; ctx.beginPath(); ctx.arc(0,0,36,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(255,255,180,0.45)';
  ctx.beginPath(); ctx.ellipse(-11,-11,18,13,-0.4,0,Math.PI*2); ctx.fill();
  ctx.restore();
}

// â”€â”€â”€ Draw: Cloud â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawCloud(x,y,s,alpha,dark) {
  ctx.save(); ctx.globalAlpha=alpha;
  ctx.fillStyle = dark ? '#8A9EAA' : 'white';
  const e=(ox,oy,rx,ry)=>{ ctx.beginPath(); ctx.ellipse(x+ox*s,y+oy*s,rx*s,ry*s,0,0,Math.PI*2); ctx.fill(); };
  e(0,0,56,28); e(46,-10,38,25); e(-42,-7,32,20); e(22,10,30,18); e(-18,10,28,17);
  ctx.restore();
}

// â”€â”€â”€ Draw: Grass tufts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGrassTufts() {
  ctx.fillStyle='#80E080';
  const step = 88;
  const offset = (tick * 0.3) % step;
  for (let tx=-step+offset; tx<W+step; tx+=step) {
    for (let b=-1;b<=1;b++) {
      const bx=tx+b*9;
      const sw=Math.sin(tick*0.012+bx*0.05)*3;
      ctx.beginPath();
      ctx.moveTo(bx,GROUND_Y+8);
      ctx.quadraticCurveTo(bx+sw+b*2,GROUND_Y-10, bx+sw*1.3+b*4,GROUND_Y-18);
      ctx.quadraticCurveTo(bx+b*2,GROUND_Y-8, bx,GROUND_Y+8);
      ctx.fill();
    }
  }
}

// â”€â”€â”€ Draw: Flower â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawFlower(f) {
  const sway = Math.sin(tick*0.013 + f.swayPhase) * f.swayAmp * (Math.PI/180);
  ctx.save();
  ctx.translate(f.x, f.y);
  ctx.rotate(sway);

  if (f.stage === 0) {
    // Seed
    ctx.fillStyle='#7B5800';
    ctx.beginPath(); ctx.ellipse(0,-5,6,4,0,0,Math.PI*2); ctx.fill();
  }
  else if (f.stage === 1) {
    // Sprout
    const h = f.def.stemH*0.28;
    ctx.strokeStyle='#4CAF50'; ctx.lineWidth=3; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-h); ctx.stroke();
    ctx.fillStyle='#81C784';
    ctx.beginPath(); ctx.ellipse(0,-h-4,5,9,0,0,Math.PI*2); ctx.fill();
  }
  else if (f.stage === 2) {
    // Bud
    const h = f.def.stemH*0.72;
    ctx.strokeStyle='#4CAF50'; ctx.lineWidth=4; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-h); ctx.stroke();
    drawLeaves(f, h*0.38, h*0.62);
    // Sepals
    ctx.fillStyle='#43A047';
    ctx.beginPath(); ctx.ellipse(0,-h-2,7,9,0,0,Math.PI*2); ctx.fill();
    // Bud petals
    ctx.fillStyle=f.petalColor;
    ctx.beginPath(); ctx.ellipse(0,-h-12,8,14,0,0,Math.PI*2); ctx.fill();
  }
  else {
    // Full bloom
    const stemW = f.def.stemH > 110 ? 6 : 4;
    ctx.strokeStyle='#4CAF50'; ctx.lineWidth=stemW; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-f.def.stemH); ctx.stroke();
    drawLeaves(f, f.def.stemH*0.33, f.def.stemH*0.62);
    ctx.save();
    ctx.translate(0, -f.def.stemH);
    drawFlowerHead(f);
    ctx.restore();
  }

  ctx.restore();
}

function drawLeaves(f, h1, h2) {
  const lw = f.def.leafW;
  ctx.fillStyle = f.leafColor;
  // Left leaf
  ctx.beginPath();
  ctx.moveTo(0,-h1);
  ctx.quadraticCurveTo(-lw,-h1-lw*0.28, -lw*0.18,-h1-lw*0.72);
  ctx.quadraticCurveTo(-lw*0.5,-h1-lw*0.38, 0,-h1);
  ctx.fill();
  // Right leaf
  ctx.beginPath();
  ctx.moveTo(0,-h2);
  ctx.quadraticCurveTo(lw,-h2-lw*0.28, lw*0.18,-h2-lw*0.72);
  ctx.quadraticCurveTo(lw*0.5,-h2-lw*0.38, 0,-h2);
  ctx.fill();
  // Leaf veins
  ctx.strokeStyle = 'rgba(0,100,0,0.25)'; ctx.lineWidth=1; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(0,-h1); ctx.lineTo(-lw*0.55,-h1-lw*0.55); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,-h2); ctx.lineTo(lw*0.55,-h2-lw*0.55); ctx.stroke();
}

function drawFlowerHead(f) {
  const {petalN:n, petalLen:pL, petalW:pW} = f.def;

  if (f.type === 'tulip') {
    drawTulip(f, pL, pW);
    return;
  }
  if (f.type === 'rose') {
    drawRose(f, pL, pW);
    return;
  }

  // Generic radial petals
  for (let i=0; i<n; i++) {
    ctx.save();
    ctx.rotate((i/n)*Math.PI*2);
    // Subtle wobble
    ctx.rotate(Math.sin(tick*0.018+i*1.3)*1.2*(Math.PI/180));
    ctx.fillStyle = f.petalColor;
    ctx.shadowColor='rgba(0,0,0,0.08)'; ctx.shadowBlur=4;
    ctx.beginPath();
    ctx.ellipse(0,-pL/2, pW/2, pL/2, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
  // Petal outlines
  ctx.strokeStyle='rgba(0,0,0,0.06)'; ctx.lineWidth=0.8;
  for (let i=0; i<n; i++) {
    ctx.save(); ctx.rotate((i/n)*Math.PI*2);
    ctx.beginPath(); ctx.ellipse(0,-pL/2,pW/2,pL/2,0,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }
  // Center
  const cR = f.type==='sunflower' ? 20 : f.type==='daisy' ? 10 : 12;
  ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=6;
  ctx.fillStyle = f.centerColor;
  ctx.beginPath(); ctx.arc(0,0,cR,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
  if (f.type === 'sunflower') {
    // Seed pattern
    ctx.fillStyle='rgba(0,0,0,0.22)';
    for (let i=0;i<8;i++){
      const a=i/8*Math.PI*2;
      ctx.beginPath(); ctx.arc(Math.cos(a)*8,Math.sin(a)*8,3.5,0,Math.PI*2); ctx.fill();
    }
    ctx.beginPath(); ctx.arc(0,0,4,0,Math.PI*2); ctx.fill();
    // Pollen shine
    ctx.fillStyle='rgba(255,220,100,0.4)';
    ctx.beginPath(); ctx.ellipse(-6,-7,7,5,-0.5,0,Math.PI*2); ctx.fill();
  } else if (f.type === 'daisy') {
    ctx.fillStyle='rgba(255,255,255,0.35)';
    ctx.beginPath(); ctx.ellipse(-3,-4,4,3,-0.4,0,Math.PI*2); ctx.fill();
  } else if (f.type === 'wildflower') {
    ctx.fillStyle='rgba(255,255,255,0.4)';
    ctx.beginPath(); ctx.ellipse(-2,-3,3,2,-0.3,0,Math.PI*2); ctx.fill();
  }
}

function drawTulip(f, pL, pW) {
  // Main cup
  ctx.fillStyle = f.petalColor;
  ctx.shadowColor='rgba(0,0,0,0.12)'; ctx.shadowBlur=6;
  ctx.beginPath();
  ctx.moveTo(-pW*0.9, 0);
  ctx.bezierCurveTo(-pW*1.6,-pL*0.45, -pW*0.9,-pL, 0,-pL*1.05);
  ctx.bezierCurveTo(pW*0.9,-pL, pW*1.6,-pL*0.45, pW*0.9,0);
  ctx.closePath(); ctx.fill();
  ctx.shadowBlur=0;

  // Inner highlight
  ctx.fillStyle = f.centerColor;
  ctx.beginPath(); ctx.ellipse(0,-pL*0.52,pW*0.55,pL*0.44,0,0,Math.PI*2); ctx.fill();

  // Side petals
  const drawSidePetal = (flip) => {
    ctx.save(); ctx.scale(flip,1); ctx.rotate(-0.42);
    ctx.fillStyle = f.petalColor;
    ctx.beginPath();
    ctx.moveTo(-pW*0.4, 0);
    ctx.bezierCurveTo(-pW*2,-pL*0.28, -pW*1.8,-pL*0.75, -pW*0.25,-pL*0.92);
    ctx.bezierCurveTo(-pW*0.7,-pL*0.5, -pW*0.3,-pL*0.1, -pW*0.4,0);
    ctx.fill(); ctx.restore();
  };
  drawSidePetal(1); drawSidePetal(-1);

  // Stamens
  ctx.strokeStyle='#FFD700'; ctx.lineWidth=1.5;
  for (let i=-1;i<=1;i++) {
    ctx.beginPath();
    ctx.moveTo(i*4,-pL*0.2); ctx.lineTo(i*5,-pL*0.6); ctx.stroke();
    ctx.fillStyle='#FF8F00'; ctx.beginPath(); ctx.arc(i*5,-pL*0.62,3,0,Math.PI*2); ctx.fill();
  }
}

function drawRose(f, pL, pW) {
  // Draw concentric petal layers, outermost first
  const layers = 4;
  for (let layer=layers; layer>=0; layer--) {
    const r = (pL / layers) * (layer + 0.5);
    const pCount = Math.max(3, 4 + layer);
    const angleOff = (layer%2) * (Math.PI/pCount) + tick*0.003;
    // Darken inner layers
    const bright = layer/layers;
    const col = lerpColor(f.centerColor, f.petalColor, bright);
    ctx.fillStyle = col;
    ctx.shadowColor='rgba(0,0,0,0.15)'; ctx.shadowBlur=4;
    for (let i=0; i<pCount; i++) {
      ctx.save();
      ctx.rotate(angleOff + (i/pCount)*Math.PI*2);
      ctx.beginPath();
      ctx.ellipse(0,-r*0.65, pW*0.55, r*0.72, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
    }
  }
  ctx.shadowBlur=0;
  // Rose center
  ctx.fillStyle = f.centerColor;
  ctx.beginPath(); ctx.arc(0,0,pW*0.4,0,Math.PI*2); ctx.fill();
}

function lerpColor(c1,c2,t) {
  const parse = c => {
    const r=parseInt(c.slice(1,3),16), g=parseInt(c.slice(3,5),16), b=parseInt(c.slice(5,7),16);
    return [r,g,b];
  };
  const [r1,g1,b1]=parse(c1), [r2,g2,b2]=parse(c2);
  const r=Math.round(r1+(r2-r1)*t), g=Math.round(g1+(g2-g1)*t), b=Math.round(b1+(b2-b1)*t);
  return `rgb(${r},${g},${b})`;
}

// â”€â”€â”€ Draw: Butterfly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawButterfly(b) {
  ctx.save();
  ctx.translate(b.x, b.y);
  const fa = b.state==='visit' ? b.faceAngle : Math.atan2(b.vy, b.vx);
  ctx.rotate(fa);
  const s=b.size, wf=Math.abs(Math.sin(b.wingPhase))*0.75+0.25;

  // Upper wings
  ctx.save(); ctx.scale(1,wf);
  ctx.fillStyle=b.color; ctx.globalAlpha=0.88;
  ctx.beginPath(); ctx.ellipse(-14*s,-6*s,18*s,11*s, 0.3,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse( 14*s,-6*s,18*s,11*s,-0.3,0,Math.PI*2); ctx.fill();
  // Lower wings
  ctx.globalAlpha=0.65;
  ctx.beginPath(); ctx.ellipse(-11*s,4*s,12*s,9*s,-0.3,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse( 11*s,4*s,12*s,9*s, 0.3,0,Math.PI*2); ctx.fill();
  // Wing spots
  ctx.fillStyle='rgba(255,255,255,0.55)'; ctx.globalAlpha=0.55;
  ctx.beginPath(); ctx.ellipse(-16*s,-7*s,5*s,4*s,0.3,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse( 16*s,-7*s,5*s,4*s,-0.3,0,Math.PI*2); ctx.fill();
  ctx.restore(); ctx.globalAlpha=1;

  // Body
  ctx.fillStyle='#2C1A00';
  ctx.beginPath(); ctx.ellipse(0,0,2.8*s,9*s,0,0,Math.PI*2); ctx.fill();
  // Antennae
  ctx.strokeStyle='#2C1A00'; ctx.lineWidth=1.2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(-2*s,-7*s); ctx.lineTo(-7*s,-17*s); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 2*s,-7*s); ctx.lineTo( 7*s,-17*s); ctx.stroke();
  ctx.fillStyle='#2C1A00';
  ctx.beginPath(); ctx.arc(-7*s,-17*s,2*s,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( 7*s,-17*s,2*s,0,Math.PI*2); ctx.fill();

  ctx.restore();
}

// â”€â”€â”€ Draw: Bee â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBee(b) {
  ctx.save();
  ctx.translate(b.x, b.y);
  const angle = b.vx!==0 ? Math.atan2(b.vy,b.vx) : 0;
  ctx.rotate(angle + Math.PI/2);

  // Wings (fast flap)
  const wf=Math.abs(Math.sin(b.wingPhase))*0.55+0.45;
  ctx.save(); ctx.scale(1,wf);
  ctx.fillStyle='rgba(190,230,255,0.72)';
  ctx.beginPath(); ctx.ellipse(-9,-8,13,8, 0.4,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse( 9,-8,13,8,-0.4,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // Abdomen (yellow + stripes)
  ctx.fillStyle='#FFD700';
  ctx.beginPath(); ctx.ellipse(0,0,8,13,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#222';
  for (const oy of [-7,-1,5]) {
    ctx.beginPath(); ctx.ellipse(0,oy,7,2.2,0,0,Math.PI*2); ctx.fill();
  }
  // Head
  ctx.fillStyle='#222';
  ctx.beginPath(); ctx.arc(0,-15,6,0,Math.PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle='#FFD700';
  ctx.beginPath(); ctx.arc(-3,-15,1.5,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( 3,-15,1.5,0,Math.PI*2); ctx.fill();
  // Antennae
  ctx.strokeStyle='#222'; ctx.lineWidth=1.2; ctx.lineCap='round';
  ctx.beginPath(); ctx.moveTo(-2,-20); ctx.lineTo(-5,-27); ctx.stroke();
  ctx.beginPath(); ctx.moveTo( 2,-20); ctx.lineTo( 5,-27); ctx.stroke();
  ctx.fillStyle='#FFD700';
  ctx.beginPath(); ctx.arc(-5,-27,2,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc( 5,-27,2,0,Math.PI*2); ctx.fill();
  // Stinger
  ctx.fillStyle='#9E6B00';
  ctx.beginPath(); ctx.moveTo(0,13); ctx.lineTo(0,20); ctx.lineTo(2,14); ctx.closePath(); ctx.fill();

  ctx.restore();
}

// â”€â”€â”€ Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
