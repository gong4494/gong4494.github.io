<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ä¸‰å›½æ€ âš”ï¸</title>
<style>
:root{
  --bg:#0e0003;--panel:#1a0007;--gold:#c9a227;--gold2:#f5d060;
  --red:#9b1a1a;--text:#f0e0c0;--dim:rgba(201,162,39,.22);
}
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
body{
  background:var(--bg);
  background-image:radial-gradient(ellipse at 20% 0%,#350008 0%,#0e0003 60%);
  color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;
  height:100vh;overflow:hidden;display:flex;flex-direction:column;
}
.hidden{display:none!important;}

/* â”€â”€ SETUP â”€â”€ */
#setup{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:16px;
  background:linear-gradient(160deg,#1e0009 0%,#0e0003 100%);z-index:50;
}
#setup h1{
  font-size:clamp(2rem,6vw,3rem);font-weight:900;letter-spacing:4px;
  background:linear-gradient(90deg,#c9a227,#f5d060,#c9a227);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
#setup p{color:#907050;font-size:.85rem;}
.char-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;justify-content:center;}
.char-pick{
  background:var(--panel);border:2px solid var(--dim);border-radius:14px;
  padding:12px;display:flex;flex-direction:column;align-items:center;gap:6px;
  cursor:pointer;transition:border-color .2s,transform .15s;width:168px;
}
.char-pick:hover{border-color:var(--gold);transform:translateY(-4px);}
.char-pick img{width:120px;height:120px;border-radius:8px;object-fit:cover;object-position:center top;border:2px solid var(--dim);}
.char-pick .cname{font-size:1.15rem;font-weight:900;color:var(--gold2);}
.char-pick .ctitle{font-size:.7rem;color:#907050;}
.char-pick .chp-setup{font-size:.85rem;}
.char-pick .cability{font-size:.7rem;color:#c0a080;text-align:center;line-height:1.5;}
.pick-btn{padding:8px 26px;background:var(--gold);color:#1a0005;border:none;border-radius:8px;font-size:.9rem;font-weight:800;cursor:pointer;}
.pick-btn:hover{filter:brightness(1.15);}

/* â”€â”€ BOARD â”€â”€ */
#board{display:flex;flex-direction:column;height:100vh;}

/* â”€â”€ ZONES â”€â”€ */
#ai-zone{
  background:linear-gradient(180deg,#180007,#0e0003);
  border-bottom:1px solid var(--dim);
  display:flex;align-items:center;gap:8px;padding:6px 10px;
  min-height:138px;flex-shrink:0;
}
#player-zone{
  background:linear-gradient(0deg,#180007,#0e0003);
  border-top:1px solid var(--dim);
  display:flex;align-items:center;gap:8px;padding:6px 10px;
  min-height:148px;flex-shrink:0;
}

/* â”€â”€ CHARACTER CARD â”€â”€ */
.char-card{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  background:var(--panel);border:1px solid var(--dim);
  border-radius:10px;padding:5px 7px;min-width:106px;flex-shrink:0;
}
.char-card img{
  width:64px;height:64px;border-radius:7px;
  object-fit:cover;object-position:center top;
  border:2px solid var(--gold);
}
.char-card .cname{font-size:.8rem;font-weight:900;color:var(--gold2);}
.chp-row{display:flex;gap:1px;flex-wrap:wrap;justify-content:center;}
.hp-heart{font-size:.8rem;}
.ability-tag{font-size:.6rem;color:#b09070;text-align:center;line-height:1.3;}

/* â”€â”€ EQUIPMENT SLOTS â”€â”€ */
.equip-zone{
  display:flex;gap:3px;margin-top:2px;
}
.equip-slot{
  width:40px;height:54px;border-radius:5px;
  border:1px dashed rgba(201,162,39,.25);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  font-size:7px;color:#605040;gap:1px;transition:all .2s;
}
.equip-slot.filled{border-color:var(--gold);border-style:solid;background:rgba(201,162,39,.1);}
.equip-slot-ico{font-size:15px;line-height:1;}
.equip-slot-label{font-size:6.5px;color:var(--gold);text-align:center;font-weight:700;}
.equip-slot-empty{font-size:7px;color:#504030;text-align:center;line-height:1.3;}

/* â”€â”€ HANDS â”€â”€ */
.hand-area{
  display:flex;flex:1;align-items:center;
  gap:4px;padding:0 4px;overflow:hidden;flex-wrap:nowrap;
}
.ai-hand-area{gap:-18px;}

/* â”€â”€ CENTER â”€â”€ */
#center-zone{
  flex:1;display:flex;flex-direction:column;justify-content:center;
  padding:4px 10px;gap:5px;
}
#play-area{
  display:flex;gap:14px;justify-content:center;align-items:center;
  min-height:108px;
}
.play-slot{display:flex;flex-direction:column;align-items:center;gap:3px;min-width:78px;}
.play-slot-label{font-size:.6rem;color:#706050;letter-spacing:1px;}
#log-box{
  background:rgba(0,0,0,.38);border:1px solid var(--dim);
  border-radius:7px;padding:5px 9px;min-height:52px;
  display:flex;flex-direction:column;gap:1px;overflow:hidden;
}
.log-line{font-size:.78rem;color:#d0b090;}
.log-line:first-child{color:#f0d090;font-weight:600;}
#ctrl-row{display:flex;gap:7px;align-items:center;justify-content:space-between;}
#phase-label{font-size:.78rem;color:#c09060;flex:1;}
.action-btn{
  padding:6px 16px;border-radius:7px;border:none;font-size:.82rem;
  font-weight:800;cursor:pointer;transition:transform .1s,filter .1s;
}
.action-btn:hover{filter:brightness(1.15);transform:translateY(-1px);}
#end-turn-btn{background:var(--gold);color:#1a0005;}
#take-hit-btn{background:#8b1a1a;color:#fff;}

/* â”€â”€ CARDS â”€â”€ */
.card{
  width:66px;height:95px;border-radius:7px;
  border:1px solid rgba(255,255,255,.15);
  box-shadow:0 3px 10px rgba(0,0,0,.6),inset 0 1px rgba(255,255,255,.07);
  position:relative;cursor:default;flex-shrink:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:transform .12s,box-shadow .12s;color:#fff;
}
.card.clickable{cursor:pointer;}
.card.clickable:hover{transform:translateY(-10px) scale(1.06);box-shadow:0 12px 24px rgba(0,0,0,.85);}
.card.selected{transform:translateY(-12px) scale(1.08)!important;box-shadow:0 0 0 3px var(--gold),0 14px 28px rgba(0,0,0,.9)!important;}
.card.dim-card{opacity:.38;pointer-events:none;}
.card.dodge-glow{box-shadow:0 0 0 3px #29b6f6,0 0 18px rgba(41,182,246,.6)!important;animation:pulseGlow 1s ease-in-out infinite;}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 0 3px #29b6f6,0 0 18px rgba(41,182,246,.4);}50%{box-shadow:0 0 0 3px #29b6f6,0 0 28px rgba(41,182,246,.8);}}
.card-corner{position:absolute;font-size:9px;line-height:1.3;text-align:center;}
.card-corner.tl{top:3px;left:4px;}.card-corner.br{bottom:3px;right:4px;transform:rotate(180deg);}
.card-ico{font-size:20px;line-height:1;margin-bottom:2px;}
.card-name{font-size:10px;font-weight:900;text-shadow:0 1px 3px rgba(0,0,0,.9);text-align:center;}
.card-desc{font-size:6.5px;color:rgba(255,255,255,.55);text-align:center;padding:0 3px;margin-top:1px;line-height:1.3;}
/* Card back */
.card.back{background:linear-gradient(135deg,#5a0010,#3a0008);}
.card-back-inner{position:absolute;inset:4px;border:1px solid rgba(201,162,39,.25);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:22px;opacity:.22;}
/* Type backgrounds */
.sha  {background:linear-gradient(135deg,#7f0000,#b52020);}
.shan {background:linear-gradient(135deg,#01579b,#1976d2);}
.tao  {background:linear-gradient(135deg,#6a0040,#b02060);}
.fire {background:linear-gradient(135deg,#bf360c,#e64a19);}
.draw {background:linear-gradient(135deg,#311b92,#6a1b9a);}
.naman{background:linear-gradient(135deg,#3e2723,#6d4c41);}
/* Equipment backgrounds */
.equip-weapon{background:linear-gradient(135deg,#3d2600,#7a5218);}
.equip-armor {background:linear-gradient(135deg,#0a2040,#1a4a8a);}
.equip-horse {background:linear-gradient(135deg,#0d3320,#1a6640);}
/* Gold border for equipment in hand */
.card.is-equip{border-color:var(--gold);border-width:2px;}

/* â”€â”€ CARD ANIMATIONS â”€â”€ */
@keyframes cardAppear{from{transform:scale(.15) rotate(-20deg);opacity:0;}to{transform:scale(1) rotate(0);opacity:1;}}
@keyframes cardDrop{from{transform:translateY(-28px);opacity:0;}to{transform:translateY(0);opacity:1;}}
@keyframes fadeOut{to{opacity:0;transform:scale(.65);}}
.anim-appear{animation:cardAppear .38s cubic-bezier(.34,1.56,.64,1);}
.anim-out{animation:fadeOut .4s ease-in forwards;}

/* â”€â”€ CHARACTER FLASH EFFECTS â”€â”€ */
@keyframes dmgFlash{0%,100%{filter:none;}30%,70%{filter:brightness(2.5) saturate(4) hue-rotate(-20deg);}60%{filter:brightness(.3);}}
@keyframes healFlash{0%,100%{filter:none;}50%{filter:brightness(2) hue-rotate(80deg) saturate(2);}}
@keyframes shieldFlash{0%,100%{filter:none;}50%{filter:brightness(2.5) hue-rotate(210deg) saturate(3);}}
@keyframes goldFlash{0%,100%{filter:none;}50%{filter:brightness(2.5) sepia(1) hue-rotate(-10deg);}}
.dmg-anim{animation:dmgFlash .55s ease;}
.heal-anim{animation:healFlash .55s ease;}
.shield-anim{animation:shieldFlash .55s ease;}
.gold-anim{animation:goldFlash .55s ease;}

/* â”€â”€ DYING MODAL â”€â”€ */
#dying-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.78);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:12px;z-index:40;backdrop-filter:blur(4px);
}
#dying-modal h2{font-size:1.7rem;color:#e84040;}
#dying-modal p{color:#c09070;font-size:.88rem;text-align:center;}
.dm-row{display:flex;gap:10px;}
.dm-btn{padding:9px 26px;border-radius:9px;border:none;font-size:.95rem;font-weight:800;cursor:pointer;}
#dm-yes{background:#ad1457;color:#fff;}#dm-no{background:#444;color:#ccc;}

/* â”€â”€ END SCREEN â”€â”€ */
#end-screen{
  position:fixed;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:14px;
  z-index:50;backdrop-filter:blur(6px);
}
#end-screen.win{background:rgba(8,35,8,.86);}
#end-screen.lose{background:rgba(35,0,8,.86);}
#end-emoji{font-size:5rem;}
#end-title{font-size:2.2rem;font-weight:900;color:#fff;}
#end-sub{font-size:.95rem;color:rgba(255,255,255,.7);}
#end-btn{padding:11px 34px;border-radius:11px;border:none;font-size:1rem;font-weight:800;cursor:pointer;background:var(--gold);color:#1a0005;}

/* Confetti */
#cfv{position:fixed;inset:0;pointer-events:none;z-index:49;}

/* Tooltip */
#card-tip{
  position:fixed;z-index:60;background:rgba(28,0,8,.96);
  border:1px solid var(--gold);border-radius:7px;padding:6px 10px;
  font-size:.76rem;color:#f0d090;pointer-events:none;display:none;
  max-width:180px;line-height:1.6;
}

/* Deck/discard info */
#deck-info{font-size:.65rem;color:#705040;text-align:center;white-space:nowrap;}

/* BAGUA flip result */
#bagua-result{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(0,0,100,.85);border:2px solid #29b6f6;
  border-radius:12px;padding:14px 24px;z-index:45;
  font-size:1.1rem;color:#fff;text-align:center;display:none;
  animation:cardAppear .35s cubic-bezier(.34,1.56,.64,1);
}
</style>
</head>
<body>

<!-- â”€â”€ SETUP â”€â”€ -->
<div id="setup">
  <h1>âš”ï¸ ä¸‰å›½æ€ âš”ï¸</h1>
  <p>é€‰æ‹©ä½ çš„æ­¦å°†ï¼Œä¸ AI å¯¹å†³ï¼ï¼ˆå«è£…å¤‡ç‰Œï¼‰</p>
  <div class="char-row" id="char-row"></div>
</div>

<!-- â”€â”€ BOARD â”€â”€ -->
<div id="board" class="hidden">
  <!-- AI Zone -->
  <div id="ai-zone">
    <div class="char-card" id="ai-char-card">
      <img id="ai-portrait" src="" alt="">
      <div class="cname" id="ai-cname"></div>
      <div class="chp-row" id="ai-hp-row"></div>
      <div class="ability-tag" id="ai-ability-tag"></div>
      <div class="equip-zone" id="ai-equip-zone">
        <div class="equip-slot" id="ai-weapon-slot"><div class="equip-slot-empty">æ­¦å™¨</div></div>
        <div class="equip-slot" id="ai-armor-slot"><div class="equip-slot-empty">é˜²å…·</div></div>
      </div>
    </div>
    <div id="ai-hand-area" class="hand-area ai-hand-area"></div>
    <div id="deck-info"></div>
  </div>

  <!-- Center Zone -->
  <div id="center-zone">
    <div id="play-area">
      <div class="play-slot">
        <div class="play-slot-label">AI å‡ºç‰Œ</div>
        <div id="ai-play-slot"></div>
      </div>
      <div class="play-slot">
        <div class="play-slot-label">ä½  å‡ºç‰Œ</div>
        <div id="player-play-slot"></div>
      </div>
    </div>
    <div id="log-box"></div>
    <div id="ctrl-row">
      <div id="phase-label">ç­‰å¾…å¼€å§‹...</div>
      <button class="action-btn hidden" id="take-hit-btn" onclick="takeHit()">ğŸ’¥ å—ä¼¤</button>
      <button class="action-btn hidden" id="end-turn-btn" onclick="endTurn()">âœ… ç»“æŸå›åˆ</button>
    </div>
  </div>

  <!-- Player Zone -->
  <div id="player-zone">
    <div class="char-card" id="player-char-card">
      <img id="player-portrait" src="" alt="">
      <div class="cname" id="player-cname"></div>
      <div class="chp-row" id="player-hp-row"></div>
      <div class="ability-tag" id="player-ability-tag"></div>
      <div class="equip-zone" id="player-equip-zone">
        <div class="equip-slot" id="player-weapon-slot"><div class="equip-slot-empty">æ­¦å™¨</div></div>
        <div class="equip-slot" id="player-armor-slot"><div class="equip-slot-empty">é˜²å…·</div></div>
      </div>
    </div>
    <div id="player-hand-area" class="hand-area"></div>
  </div>
</div>

<!-- â”€â”€ DYING MODAL â”€â”€ -->
<div id="dying-modal" class="hidden">
  <h2>ğŸ’€ æ¿’æ­»ï¼</h2>
  <p id="dying-msg"></p>
  <div class="dm-row">
    <button class="dm-btn" id="dm-yes">ğŸ‘ ä½¿ç”¨æ¡ƒè‡ªæ•‘</button>
    <button class="dm-btn" id="dm-no">æ”¾å¼ƒ â˜ ï¸</button>
  </div>
</div>

<!-- â”€â”€ END SCREEN â”€â”€ -->
<div id="end-screen" class="hidden">
  <div id="end-emoji"></div>
  <div id="end-title"></div>
  <div id="end-sub"></div>
  <button id="end-btn" onclick="location.reload()">ğŸ”„ å†æ¥ä¸€å±€</button>
</div>
<canvas id="cfv"></canvas>
<div id="card-tip"></div>
<div id="bagua-result"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHARS = [
  {id:0, name:'å°å°†å†›', title:'ä¸€é©¬å½“å…ˆ',  photo:'sanguosha_p1.jpg', maxHp:4,
   ability:'åšéŸ§', abilityDesc:'å—åˆ°ä¼¤å®³æ—¶30%æ¦‚ç‡å…ç–«ä¸€æ¬¡ä¼¤å®³'},
  {id:1, name:'å¤§å°†å†›', title:'æ™ºå‹‡åŒå…¨',  photo:'sanguosha_p2.jpg', maxHp:4,
   ability:'ç¥æœº', abilityDesc:'æ¯å›åˆæ‘¸ç‰Œé˜¶æ®µå¤šæ‘¸1å¼ ç‰Œ'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARD DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CDEFS = {
  // Basic cards
  SHA:      {name:'æ€',       cls:'sha',          icon:'âš”ï¸',  desc:'é€ æˆ1ç‚¹ä¼¤å®³ï¼ˆå¯¹æ‰‹å¯å‡ºé—ªæŠµæŒ¡ï¼‰',       equip:false},
  SHAN:     {name:'é—ª',       cls:'shan',         icon:'ğŸ›¡ï¸', desc:'æŠµæ¶ˆä¸€æ¬¡å¯¹ä½ çš„æ€',                    equip:false},
  TAO:      {name:'æ¡ƒ',       cls:'tao',          icon:'ğŸ‘',  desc:'æ¢å¤1ç‚¹ä½“åŠ›ï¼ˆä¸è¶…è¿‡ä¸Šé™ï¼‰',            equip:false},
  FIRE:     {name:'ç«æ”»',     cls:'fire',         icon:'ğŸ”¥',  desc:'é€ æˆ2ç‚¹ä¼¤å®³ï¼Œå¯¹æ‰‹æ— æ³•ç”¨é—ªæŠµæŒ¡',        equip:false},
  DRAW:     {name:'æ— ä¸­ç”Ÿæœ‰', cls:'draw',         icon:'âœ¨',  desc:'ç«‹å³æ‘¸2å¼ ç‰Œ',                         equip:false},
  NAMAN:    {name:'å—è›®å…¥ä¾µ', cls:'naman',        icon:'ğŸ¹',  desc:'å¯¹æ‰‹é¡»å‡ºä¸€å¼ æ€ï¼Œå¦åˆ™å—1ç‚¹ä¼¤å®³',        equip:false},
  // Equipment â€” Weapons
  CROSSBOW: {name:'è¯¸è‘›è¿å¼©', cls:'equip-weapon', icon:'ğŸ”©',  desc:'è£…å¤‡æ­¦å™¨ï¼šæ¯å›åˆå¯ä½¿ç”¨ä»»æ„å¼ æ€',       equip:true,  slot:'weapon'},
  BLADE:    {name:'é’é¾™åƒæœˆ', cls:'equip-weapon', icon:'ğŸ—¡ï¸', desc:'è£…å¤‡æ­¦å™¨ï¼šæ€è¢«é—ªåï¼Œå¯ç«‹å³å†å‡ºä¸€å¼ æ€', equip:true,  slot:'weapon'},
  // Equipment â€” Armor
  BAGUA:    {name:'å…«å¦é˜µ',   cls:'equip-armor',  icon:'â˜¯ï¸',  desc:'è£…å¤‡é˜²å…·ï¼šè¢«æ€æ—¶ç¿»ç‰Œï¼Œçº¢è‰²åˆ™è‡ªåŠ¨æ ¼æŒ¡', equip:true,  slot:'armor'},
  SHIELD:   {name:'ä»ç‹ç›¾',   cls:'equip-armor',  icon:'ğŸ›¡ï¸', desc:'è£…å¤‡é˜²å…·ï¼šé»‘è‰²çš„æ€å¯¹ä½ æ— æ•ˆï¼ˆâ™ /â™£ï¼‰',   equip:true,  slot:'armor'},
};

const SUITS = ['â™ ','â™¥','â™¦','â™£'];
const NUMS  = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

function makeDeck(){
  const counts={SHA:14,SHAN:8,TAO:5,FIRE:3,DRAW:3,NAMAN:2,CROSSBOW:2,BLADE:1,BAGUA:2,SHIELD:1};
  let idx=0, deck=[];
  for(const [type,n] of Object.entries(counts))
    for(let i=0;i<n;i++) deck.push({type, suit:SUITS[idx%4], num:NUMS[idx%13], uid:idx++});
  for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
  return deck;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = {
  phase:'SETUP',
  deck:[], discard:[],
  pl:  {char:null, hp:4, hand:[], slashUsed:0, equip:{weapon:null, armor:null}},
  ai:  {char:null, hp:4, hand:[], slashUsed:0, equip:{weapon:null, armor:null}},
  pendingResp: null,  // {resolve, validTypes, damage}
  log: [],
};

const sleep = ms => new Promise(r => setTimeout(r, ms));

function drawCard(hand){
  if(G.deck.length===0){
    if(!G.discard.length) return;
    G.deck=[...G.discard]; G.discard=[];
    for(let i=G.deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[G.deck[i],G.deck[j]]=[G.deck[j],G.deck[i]];}
    addLog('ğŸ”„ ç‰Œå †é‡æ´—...');
  }
  hand.push(G.deck.pop());
}
function removeCard(card, hand){
  const i=hand.findIndex(c=>c.uid===card.uid);
  if(i>=0){const[c]=hand.splice(i,1); G.discard.push(c);}
}
// Equip a card: old equip goes to discard
function equipCard(card, who){
  const def=CDEFS[card.type];
  const slot=def.slot; // 'weapon' or 'armor'
  if(who.equip[slot]){G.discard.push(who.equip[slot]);} // discard old
  who.equip[slot]=card;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGGING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(msg){
  G.log.unshift(msg);
  if(G.log.length>6) G.log.pop();
  document.getElementById('log-box').innerHTML=
    G.log.map((m,i)=>`<div class="log-line" style="opacity:${Math.max(.28,1-i*.15)}">${m}</div>`).join('');
}
function setPhase(txt){document.getElementById('phase-label').textContent=txt;}
function showBtn(id,v){document.getElementById(id).classList.toggle('hidden',!v);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hpHtml(cur,max){
  return Array.from({length:max},(_,i)=>`<span class="hp-heart">${i<cur?'â¤ï¸':'ğŸ–¤'}</span>`).join('');
}

// Render the equipment slots for one player
function renderEquip(who, prefix){
  ['weapon','armor'].forEach(slot=>{
    const el=document.getElementById(`${prefix}-${slot}-slot`);
    const card=who.equip[slot];
    if(card){
      const def=CDEFS[card.type];
      el.className='equip-slot filled';
      el.innerHTML=`<div class="equip-slot-ico">${def.icon}</div><div class="equip-slot-label">${def.name}</div>`;
      el.title=def.desc;
    } else {
      el.className='equip-slot';
      el.innerHTML=`<div class="equip-slot-empty">${slot==='weapon'?'æ­¦å™¨':'é˜²å…·'}</div>`;
    }
  });
}

// Build a card DOM element
function makeCardEl(card, opts={}){
  const def=CDEFS[card.type];
  const isRed=card.suit==='â™¥'||card.suit==='â™¦';
  const sc=isRed?'#ff8080':'#ddd';
  const el=document.createElement('div');
  el.className=`card ${def.cls}${def.equip?' is-equip':''}${opts.clickable?' clickable':''}${opts.dodge?' dodge-glow':''}${opts.dim?' dim-card':''}`;
  el.dataset.uid=card.uid;
  el.innerHTML=`
    <div class="card-corner tl" style="color:${sc}"><div>${card.num}</div><div>${card.suit}</div></div>
    <div class="card-ico">${def.icon}</div>
    <div class="card-name">${def.name}</div>
    <div class="card-desc">${def.desc.slice(0,16)}</div>
    <div class="card-corner br" style="color:${sc}"><div>${card.num}</div><div>${card.suit}</div></div>
  `;
  if(opts.clickable) el.addEventListener('click',()=>onCardClick(card));
  const tip=document.getElementById('card-tip');
  el.addEventListener('mouseenter',e=>{
    tip.textContent=`${def.icon} ${def.name}ï¼š${def.desc}`;
    tip.style.display='block';
    tip.style.left=e.clientX+14+'px';tip.style.top=e.clientY-8+'px';
  });
  el.addEventListener('mousemove',e=>{tip.style.left=e.clientX+14+'px';tip.style.top=e.clientY-8+'px';});
  el.addEventListener('mouseleave',()=>tip.style.display='none');
  return el;
}
function makeBackEl(){
  const el=document.createElement('div');
  el.className='card back';
  el.innerHTML='<div class="card-back-inner">âš”ï¸</div>';
  return el;
}

function renderPlayerHand(){
  const area=document.getElementById('player-hand-area'); area.innerHTML='';
  const awaitResp=G.phase==='AWAIT_RESPONSE'&&G.pendingResp;
  const validTypes=awaitResp?G.pendingResp.validTypes:[];
  const canPlay=G.phase==='PLAYER_PLAY';
  G.pl.hand.forEach(card=>{
    const dodge=validTypes.includes(card.type);
    const el=makeCardEl(card,{
      clickable: canPlay||dodge,
      dodge,
      dim: awaitResp&&!dodge,
    });
    area.appendChild(el);
  });
}
function renderAiHand(){
  const area=document.getElementById('ai-hand-area'); area.innerHTML='';
  G.ai.hand.forEach((_,i)=>{
    const el=makeBackEl();
    el.style.marginLeft=i>0?'-18px':'0';
    area.appendChild(el);
  });
}
function renderHp(){
  document.getElementById('player-hp-row').innerHTML=hpHtml(G.pl.hp,G.pl.char.maxHp);
  document.getElementById('ai-hp-row').innerHTML=hpHtml(G.ai.hp,G.ai.char.maxHp);
  document.getElementById('deck-info').textContent=`ç‰Œå †:${G.deck.length} å¼ƒ:${G.discard.length}`;
}
function renderAll(){
  renderPlayerHand();
  renderAiHand();
  renderHp();
  renderEquip(G.pl,'player');
  renderEquip(G.ai,'ai');
}

// Show a played card in center with animation
function showPlayedCard(card, who){
  const slot=document.getElementById(who==='ai'?'ai-play-slot':'player-play-slot');
  slot.innerHTML='';
  const el=makeCardEl(card,{});
  el.classList.add('anim-appear');
  slot.appendChild(el);
  setTimeout(()=>{el.classList.add('anim-out');setTimeout(()=>{if(slot.contains(el))slot.innerHTML='';},440);},1500);
}

function flashChar(who, type){
  const id=who==='ai'?'ai-char-card':'player-char-card';
  const el=document.getElementById(id);
  const cls={dmg:'dmg-anim',heal:'heal-anim',shield:'shield-anim',gold:'gold-anim'}[type]||'dmg-anim';
  el.classList.add(cls);
  setTimeout(()=>el.classList.remove(cls),650);
}
function flashMsg(msg){
  const lbl=document.getElementById('phase-label');
  const old=lbl.textContent;
  lbl.style.color='#ff5050';lbl.textContent=msg;
  setTimeout(()=>{lbl.style.color='';lbl.textContent=old;},1200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BAGUA FLIP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function baguaFlip(){
  // Flip top card of deck; if red (â™¥/â™¦) â†’ dodge
  if(G.deck.length===0) return false;
  const top=G.deck[G.deck.length-1];
  const isRed=top.suit==='â™¥'||top.suit==='â™¦';
  const br=document.getElementById('bagua-result');
  br.style.display='block';
  br.innerHTML=isRed
    ?`â˜¯ï¸ å…«å¦é˜µï¼<br>ç¿»åˆ° <b style="color:#ff8080">${top.suit}${top.num}</b>ï¼ˆçº¢è‰²ï¼‰<br>âœ¨ è‡ªåŠ¨æ ¼æŒ¡ï¼`
    :`â˜¯ï¸ å…«å¦é˜µï¼<br>ç¿»åˆ° <b style="color:#aaa">${top.suit}${top.num}</b>ï¼ˆé»‘è‰²ï¼‰<br>âŒ æ ¼æŒ¡å¤±è´¥...`;
  await sleep(1600);
  br.style.display='none';
  return isRed;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAMAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function dealDmgToPlayer(amount, isSha=false){
  // ä»ç‹ç›¾: if the SHA is black-suited, immune
  if(isSha && G.pl.equip.armor?.type==='SHIELD'){
    // The card that caused this damage â€“ we don't track suit here, so we just say black-suited SHA is blocked
    // Simplified: 50% chance to block with shield
    if(Math.random()<.5){
      addLog('ğŸ›¡ï¸ ä»ç‹ç›¾ï¼é»‘è‰²çš„æ€æ— æ•ˆï¼');
      flashChar('pl','shield');
      await sleep(500);
      return;
    }
  }
  // åšéŸ§: 30% immunity (char 0)
  if(G.pl.char.id===0 && Math.random()<.30){
    addLog('ğŸ›¡ï¸ åšéŸ§ï¼ä½ å…ç–«äº†æ­¤æ¬¡ä¼¤å®³ï¼');
    flashChar('pl','shield');
    await sleep(500);
    return;
  }
  G.pl.hp=Math.max(0,G.pl.hp-amount);
  flashChar('pl','dmg');
  addLog(`ğŸ’” ä½ å—åˆ° ${amount} ç‚¹ä¼¤å®³ï¼Œå‰©ä½™ä½“åŠ› ${G.pl.hp}`);
  renderHp();
  await sleep(400);
  if(G.pl.hp<=0) await playerDying();
}

async function dealDmgToAI(amount){
  G.ai.hp=Math.max(0,G.ai.hp-amount);
  flashChar('ai','dmg');
  addLog(`ğŸ’¥ AIå—åˆ° ${amount} ç‚¹ä¼¤å®³ï¼Œå‰©ä½™ä½“åŠ› ${G.ai.hp}`);
  renderHp();
  await sleep(400);
  if(G.ai.hp<=0){
    const p=G.ai.hand.find(c=>c.type==='TAO');
    if(p){
      removeCard(p,G.ai.hand);G.ai.hp=1;
      addLog('ğŸ‘ AIæ¿’æ­»ï¼Œç”¨æ¡ƒè‡ªæ•‘ï¼æ¢å¤åˆ°1ç‚¹ä½“åŠ›');
      flashChar('ai','heal');showPlayedCard(p,'ai');
      renderAll();await sleep(900);
    } else { gameOver(true); }
  }
}

function playerDying(){
  return new Promise(resolve=>{
    const p=G.pl.hand.find(c=>c.type==='TAO');
    const m=document.getElementById('dying-modal');
    document.getElementById('dying-msg').textContent=p
      ?'ä½ çš„ä½“åŠ›å½’é›¶ï¼ä½¿ç”¨æ¡ƒæ¢å¤åˆ°1ç‚¹ä½“åŠ›ï¼Ÿ'
      :'ä½ çš„ä½“åŠ›å½’é›¶ï¼Œä¸”æ²¡æœ‰æ¡ƒï¼';
    document.getElementById('dm-yes').classList.toggle('hidden',!p);
    document.getElementById('dm-no').textContent=p?'æ”¾å¼ƒ â˜ ï¸':'â˜ ï¸ ç¡®è®¤';
    m.classList.remove('hidden');
    document.getElementById('dm-yes').onclick=()=>{
      m.classList.add('hidden');
      removeCard(p,G.pl.hand);G.pl.hp=1;
      addLog('ğŸ‘ ä½ ç”¨æ¡ƒè‡ªæ•‘ï¼æ¢å¤åˆ°1ç‚¹ä½“åŠ›');
      flashChar('pl','heal');renderAll();resolve();
    };
    document.getElementById('dm-no').onclick=()=>{m.classList.add('hidden');gameOver(false);resolve();};
  });
}

function isOver(){return G.pl.hp<=0||G.ai.hp<=0;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERACTION â€” PLAYER TURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function onCardClick(card){
  const def=CDEFS[card.type];

  // â”€â”€ Response phase (dodge / naman reply) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(G.phase==='AWAIT_RESPONSE'&&G.pendingResp){
    const pr=G.pendingResp;
    if(!pr.validTypes.includes(card.type)){
      flashMsg(`è¯·å‡º ${pr.validTypes.map(t=>CDEFS[t].name).join('/')}ï¼`);
      return;
    }
    removeCard(card,G.pl.hand);
    addLog(`ğŸ›¡ï¸ ä½ å‡ºäº†ã€${def.name}ã€‘æˆåŠŸåº”å¯¹ï¼`);
    showPlayedCard(card,'player');
    showBtn('take-hit-btn',false);
    const resolve=pr.resolve; G.pendingResp=null;
    G.phase='AI_TURN';
    renderAll();
    await sleep(500);
    resolve('blocked');
    return;
  }

  if(G.phase!=='PLAYER_PLAY') return;

  // â”€â”€ Normal play â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(def.equip){
    // Equip card
    removeCard(card,G.pl.hand);
    equipCard(card,G.pl);
    addLog(`âš™ï¸ ä½ è£…å¤‡äº†ã€${def.name}ã€‘ï¼${def.desc}`);
    flashChar('pl','gold');
    showPlayedCard(card,'player');
    renderAll();
    return;
  }

  switch(card.type){
    case 'SHA': {
      const crossbow = G.pl.equip.weapon?.type==='CROSSBOW';
      if(!crossbow && G.pl.slashUsed>=1){flashMsg('æ¯å›åˆåªèƒ½å‡º1å¼ æ€ï¼ï¼ˆè¿å¼©å¯æ— é™ï¼‰');return;}
      removeCard(card,G.pl.hand);
      G.pl.slashUsed++;
      addLog('âš”ï¸ ä½ å‡ºäº†ã€æ€ã€‘ï¼Œå¯¹AIå‘åŠ¨æ”»å‡»ï¼');
      showPlayedCard(card,'player');
      renderAll();
      const prev=G.phase; G.phase='AI_TURN';
      showBtn('end-turn-btn',false);
      await sleep(800);
      const dodged=await resolvePlayerAttack(1, card);
      if(isOver()) return;
      // BLADE follow-up
      if(dodged && G.pl.equip.weapon?.type==='BLADE'){
        const nextSha=G.pl.hand.find(c=>c.type==='SHA');
        if(nextSha){
          addLog('ğŸ—¡ï¸ é’é¾™åƒæœˆï¼AIå‡ºäº†é—ªï¼Œä½ å¯å†å‡ºä¸€å¼ æ€ï¼');
          G.phase='PLAYER_PLAY'; showBtn('end-turn-btn',true);
          setPhase('é’é¾™åƒæœˆæ•ˆæœï¼å¯å†å‡ºä¸€å¼ ã€æ€ã€‘');
          renderAll();
          return; // let player manually click the next SHA
        }
      }
      G.phase='PLAYER_PLAY'; showBtn('end-turn-btn',true);
      setPhase('ä½ çš„å›åˆ â€” ç‚¹å‡»æ‰‹ç‰Œå‡ºç‰Œï¼Œæˆ–ç»“æŸå›åˆ');
      renderAll();
      break;
    }
    case 'SHAN':  flashMsg('è¿›æ”»æ—¶æ‰èƒ½å‡ºé—ªï¼'); break;
    case 'TAO':
      if(G.pl.hp>=G.pl.char.maxHp){flashMsg('ä½“åŠ›å·²æ»¡ï¼');return;}
      removeCard(card,G.pl.hand);
      G.pl.hp=Math.min(G.pl.char.maxHp,G.pl.hp+1);
      addLog(`ğŸ‘ ä½ ç”¨äº†ã€æ¡ƒã€‘ï¼Œæ¢å¤1ç‚¹ä½“åŠ› â†’ ${G.pl.hp}`);
      flashChar('pl','heal');showPlayedCard(card,'player');renderAll();
      break;
    case 'FIRE':
      removeCard(card,G.pl.hand);
      addLog('ğŸ”¥ ç«æ”»ï¼å¯¹AIé€ æˆ2ç‚¹ä¼¤å®³ï¼ˆæ— æ³•æŠµæŒ¡ï¼‰');
      showPlayedCard(card,'player');renderAll();
      G.phase='AI_TURN';showBtn('end-turn-btn',false);
      await sleep(800);await dealDmgToAI(2);
      if(isOver()) return;
      G.phase='PLAYER_PLAY';showBtn('end-turn-btn',true);
      setPhase('ä½ çš„å›åˆ â€” ç‚¹å‡»æ‰‹ç‰Œå‡ºç‰Œï¼Œæˆ–ç»“æŸå›åˆ');renderAll();
      break;
    case 'DRAW':
      removeCard(card,G.pl.hand);
      drawCard(G.pl.hand);drawCard(G.pl.hand);
      addLog('âœ¨ æ— ä¸­ç”Ÿæœ‰ï¼ä½ æ‘¸äº†2å¼ ç‰Œ');
      showPlayedCard(card,'player');renderAll();
      break;
    case 'NAMAN':
      removeCard(card,G.pl.hand);
      addLog('ğŸ¹ å—è›®å…¥ä¾µï¼AIé¡»å‡ºä¸€å¼ ã€æ€ã€‘å¦åˆ™å—1ç‚¹ä¼¤å®³');
      showPlayedCard(card,'player');renderAll();
      G.phase='AI_TURN';showBtn('end-turn-btn',false);
      await sleep(800);await resolveNamanOnAI();
      if(isOver()) return;
      G.phase='PLAYER_PLAY';showBtn('end-turn-btn',true);
      setPhase('ä½ çš„å›åˆ â€” ç‚¹å‡»æ‰‹ç‰Œå‡ºç‰Œï¼Œæˆ–ç»“æŸå›åˆ');renderAll();
      break;
  }
}

// Player attacked AI â†’ AI auto-responds (returns true if AI dodged)
async function resolvePlayerAttack(damage, attackCard){
  await sleep(600);
  const shan=G.ai.hand.find(c=>c.type==='SHAN');
  // AI dodges smartly: dodge if hp>1 or 50/50, 70% chance
  if(shan && (G.ai.hp>1||Math.random()<.5) && Math.random()<.72){
    removeCard(shan,G.ai.hand);
    addLog('ğŸ›¡ï¸ AIå‡ºäº†ã€é—ªã€‘ï¼Œèº²è¿‡æ”»å‡»ï¼');
    showPlayedCard(shan,'ai');renderAll();
    await sleep(700);
    return true; // dodged
  }
  await dealDmgToAI(damage);
  return false; // hit
}

async function resolveNamanOnAI(){
  await sleep(700);
  const sha=G.ai.hand.find(c=>c.type==='SHA');
  if(sha){
    removeCard(sha,G.ai.hand);
    addLog('âš”ï¸ AIå‡ºäº†ã€æ€ã€‘ï¼ŒæŠµæŒ¡å—è›®å…¥ä¾µï¼');
    showPlayedCard(sha,'ai');renderAll();await sleep(700);
  } else {
    addLog('âŒ AIæ— æ€å¯å‡ºï¼Œå—1ç‚¹ä¼¤å®³ï¼');
    await dealDmgToAI(1);
  }
}

// â”€â”€â”€ AI attacked player â†’ await player dodge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function awaitPlayerDodge(damage){
  return new Promise(async resolve=>{
    // BAGUA armor check
    if(G.pl.equip.armor?.type==='BAGUA'){
      addLog('â˜¯ï¸ å…«å¦é˜µå‘åŠ¨ï¼');
      await sleep(400);
      const red=await baguaFlip();
      if(red){
        addLog('â˜¯ï¸ ç¿»åˆ°çº¢ç‰Œï¼å…«å¦é˜µè‡ªåŠ¨æ ¼æŒ¡ï¼');
        flashChar('pl','shield');
        await sleep(500);
        resolve('blocked');
        return;
      }
      addLog('â˜¯ï¸ ç¿»åˆ°é»‘ç‰Œï¼Œæ ¼æŒ¡å¤±è´¥...');
    }
    // Check ä»ç‹ç›¾: handled in dealDmgToPlayer
    // Let player choose
    G.phase='AWAIT_RESPONSE';
    G.pendingResp={resolve,validTypes:['SHAN'],damage};
    const shanCount=G.pl.hand.filter(c=>c.type==='SHAN').length;
    showBtn('take-hit-btn',true);
    setPhase(`âš ï¸ AIå‡ºäº†ã€æ€ã€‘ï¼${shanCount>0?`ç‚¹äº®çš„ã€é—ªã€‘å¯æ ¼æŒ¡ (${shanCount}å¼ )`:'ä½ æ²¡æœ‰é—ªï¼'}æˆ–ç‚¹ã€å—ä¼¤ã€‘`);
    renderPlayerHand();
  });
}

function awaitPlayerShaForNaman(){
  return new Promise(resolve=>{
    G.phase='AWAIT_RESPONSE';
    G.pendingResp={resolve,validTypes:['SHA'],damage:1};
    const n=G.pl.hand.filter(c=>c.type==='SHA').length;
    showBtn('take-hit-btn',true);
    setPhase(`âš ï¸ å—è›®å…¥ä¾µï¼${n>0?`å‡ºä¸€å¼ ã€æ€ã€‘å¯æŠµæŒ¡ (${n}å¼ )`:'ä½ æ²¡æœ‰æ€ï¼'}æˆ–ç‚¹ã€å—ä¼¤ã€‘`);
    renderPlayerHand();
  });
}

window.takeHit=function(){
  if(G.phase!=='AWAIT_RESPONSE'||!G.pendingResp) return;
  showBtn('take-hit-btn',false);
  const{damage,resolve}=G.pendingResp; G.pendingResp=null;
  G.phase='AI_TURN';
  addLog('ğŸ’¥ ä½ é€‰æ‹©å—ä¼¤...');
  dealDmgToPlayer(damage,true).then(()=>{if(!isOver()){renderAll();resolve('hit');}});
};

function endTurn(){
  if(G.phase!=='PLAYER_PLAY') return;
  const LIMIT=4;
  if(G.pl.hand.length>LIMIT){
    const prio={SHA:6,SHAN:5,TAO:4,FIRE:5,DRAW:3,NAMAN:3,CROSSBOW:4,BLADE:5,BAGUA:4,SHIELD:4};
    G.pl.hand.sort((a,b)=>prio[b.type]-prio[a.type]);
    while(G.pl.hand.length>LIMIT){
      const c=G.pl.hand.pop(); G.discard.push(c);
      addLog(`ğŸ—‘ï¸ å¼ƒç‰Œï¼šã€${CDEFS[c.type].name}ã€‘`);
    }
    renderAll();
  }
  showBtn('end-turn-btn',false);
  G.pl.slashUsed=0;
  G.phase='AI_TURN';
  setTimeout(aiTurn,600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI TURN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function aiTurn(){
  G.phase='AI_TURN';
  setPhase('AI å›åˆä¸­...');
  await sleep(500);

  // Draw
  const extra=G.ai.char.id===1?1:0;
  const n=2+extra;
  for(let i=0;i<n;i++) drawCard(G.ai.hand);
  addLog(`ğŸ¤– AIæ‘¸äº† ${n} å¼ ç‰Œ`);
  renderAll();
  await sleep(700);

  G.ai.slashUsed=0;

  // Try to equip
  const equipPriority=['CROSSBOW','BLADE','BAGUA','SHIELD'];
  for(const etype of equipPriority){
    const ec=G.ai.hand.find(c=>c.type===etype);
    if(ec && !G.ai.equip[CDEFS[etype].slot]){
      removeCard(ec,G.ai.hand);
      equipCard(ec,G.ai);
      addLog(`âš™ï¸ AIè£…å¤‡äº†ã€${CDEFS[etype].name}ã€‘ï¼`);
      flashChar('ai','gold');
      showPlayedCard(ec,'ai');
      renderAll();await sleep(900);
      break;
    }
  }

  // Play actions
  let acted=true;
  while(acted){
    acted=false;
    if(isOver()) return;

    // Heal if low
    if(G.ai.hp<=2){
      const t=G.ai.hand.find(c=>c.type==='TAO');
      if(t&&G.ai.hp<G.ai.char.maxHp){
        removeCard(t,G.ai.hand);G.ai.hp++;
        addLog(`ğŸ‘ AIç”¨äº†ã€æ¡ƒã€‘ï¼Œæ¢å¤1ç‚¹ä½“åŠ› â†’ ${G.ai.hp}`);
        flashChar('ai','heal');showPlayedCard(t,'ai');renderAll();await sleep(900);acted=true;continue;
      }
    }
    // Draw extra
    if(G.ai.hand.length<=2){
      const t=G.ai.hand.find(c=>c.type==='DRAW');
      if(t){
        removeCard(t,G.ai.hand);drawCard(G.ai.hand);drawCard(G.ai.hand);
        addLog('âœ¨ AIç”¨äº†ã€æ— ä¸­ç”Ÿæœ‰ã€‘ï¼Œæ‘¸2å¼ ç‰Œ');
        showPlayedCard(t,'ai');renderAll();await sleep(800);acted=true;continue;
      }
    }
    // Fire
    const fire=G.ai.hand.find(c=>c.type==='FIRE');
    if(fire&&Math.random()<.6){
      removeCard(fire,G.ai.hand);
      addLog('ğŸ”¥ AIå‡ºäº†ã€ç«æ”»ã€‘ï¼å¯¹ä½ é€ æˆ2ç‚¹ä¼¤å®³ï¼');
      showPlayedCard(fire,'ai');renderAll();await sleep(900);
      await dealDmgToPlayer(2,false);
      if(isOver()) return;
      renderAll();acted=true;break;
    }
    // Naman
    const naman=G.ai.hand.find(c=>c.type==='NAMAN');
    if(naman&&Math.random()<.55){
      removeCard(naman,G.ai.hand);
      addLog('ğŸ¹ AIå‡ºäº†ã€å—è›®å…¥ä¾µã€‘ï¼ä½ é¡»å‡ºä¸€å¼ ã€æ€ã€‘ï¼');
      showPlayedCard(naman,'ai');renderAll();await sleep(800);
      const res=await awaitPlayerShaForNaman();
      showBtn('take-hit-btn',false);
      if(isOver()) return;
      renderAll();await sleep(400);acted=true;continue;
    }
    // SHA
    const crossbow=G.ai.equip.weapon?.type==='CROSSBOW';
    if(crossbow||G.ai.slashUsed<1){
      const sha=G.ai.hand.find(c=>c.type==='SHA');
      if(sha){
        removeCard(sha,G.ai.hand);G.ai.slashUsed++;
        addLog('âš”ï¸ AIå‡ºäº†ã€æ€ã€‘ï¼Œæ”»å‡»ä½ ï¼');
        showPlayedCard(sha,'ai');renderAll();await sleep(900);
        const res=await awaitPlayerDodge(1);
        showBtn('take-hit-btn',false);
        if(res==='hit') await dealDmgToPlayer(1,true);
        if(isOver()) return;
        // BLADE follow-up for AI
        if(res==='blocked'&&G.ai.equip.weapon?.type==='BLADE'){
          const sha2=G.ai.hand.find(c=>c.type==='SHA');
          if(sha2&&Math.random()<.7){
            removeCard(sha2,G.ai.hand);
            addLog('ğŸ—¡ï¸ AIé’é¾™åƒæœˆæ•ˆæœï¼å†å‡ºä¸€å¼ æ€ï¼');
            showPlayedCard(sha2,'ai');renderAll();await sleep(900);
            const res2=await awaitPlayerDodge(1);
            showBtn('take-hit-btn',false);
            if(res2==='hit') await dealDmgToPlayer(1,true);
            if(isOver()) return;
          }
        }
        renderAll();await sleep(400);acted=true;break;
      }
    }
    break;
  }

  // Discard excess
  const LIMIT=4;
  const prio={SHA:6,SHAN:5,TAO:4,FIRE:5,DRAW:3,NAMAN:3,CROSSBOW:4,BLADE:5,BAGUA:4,SHIELD:4};
  G.ai.hand.sort((a,b)=>prio[b.type]-prio[a.type]);
  while(G.ai.hand.length>LIMIT){
    const c=G.ai.hand.pop();G.discard.push(c);
    addLog('ğŸ—‘ï¸ AIå¼ƒäº†ä¸€å¼ ç‰Œ');await sleep(300);
  }
  renderAll();
  await sleep(600);
  G.phase='PLAYER_PLAY';
  playerDraw();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TURN START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function playerDraw(){
  const extra=G.pl.char.id===1?1:0;
  const n=2+extra;
  for(let i=0;i<n;i++) drawCard(G.pl.hand);
  addLog(`ğŸ“¤ ä½ æ‘¸äº† ${n} å¼ ç‰Œ`);
  G.pl.slashUsed=0;
  showBtn('end-turn-btn',true);
  setPhase('ä½ çš„å›åˆ â€” ç‚¹å‡»æ‰‹ç‰Œå‡ºç‰Œï¼Œæˆ–ç»“æŸå›åˆ');
  renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  START / END GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(idx){
  const aiIdx=idx===0?1:0;
  G.pl.char=CHARS[idx];   G.pl.hp=CHARS[idx].maxHp;   G.pl.hand=[];G.pl.slashUsed=0;G.pl.equip={weapon:null,armor:null};
  G.ai.char=CHARS[aiIdx]; G.ai.hp=CHARS[aiIdx].maxHp; G.ai.hand=[];G.ai.slashUsed=0;G.ai.equip={weapon:null,armor:null};
  G.deck=makeDeck();G.discard=[];G.log=[];
  for(let i=0;i<4;i++){drawCard(G.pl.hand);drawCard(G.ai.hand);}

  document.getElementById('setup').classList.add('hidden');
  document.getElementById('board').classList.remove('hidden');

  const setC=(who,c)=>{
    document.getElementById(who+'-portrait').src=c.photo;
    document.getElementById(who+'-cname').textContent=c.name;
    document.getElementById(who+'-ability-tag').textContent=`ã€${c.ability}ã€‘${c.abilityDesc.slice(0,14)}`;
  };
  setC('player',G.pl.char);setC('ai',G.ai.char);

  addLog('âš”ï¸ æ¸¸æˆå¼€å§‹ï¼å…ˆæ”»ï¼šä½ ');
  addLog(`ğŸ‘¤ ä½ æ˜¯ã€${G.pl.char.name}ã€‘VS AIã€${G.ai.char.name}ã€‘`);
  G.phase='PLAYER_PLAY';
  playerDraw();
}

function gameOver(win){
  G.phase='END';
  showBtn('end-turn-btn',false);showBtn('take-hit-btn',false);
  stopConfetti();
  const s=document.getElementById('end-screen');
  s.className=win?'win':'lose';
  document.getElementById('end-emoji').textContent=win?'ğŸ‰':'ğŸ’€';
  document.getElementById('end-title').textContent=win?'èƒœåˆ©ï¼':'è´¥åŒ—...';
  document.getElementById('end-sub').textContent=win
    ?`ä½ ä»¥ ${G.pl.hp} ç‚¹ä½“åŠ›å‡»è´¥äº† ${G.ai.char.name}ï¼`
    :`${G.ai.char.name} è·èƒœï¼ä¸‹æ¬¡ä¸€å®šï¼`;
  s.classList.remove('hidden');
  if(win) launchConfetti();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSetup(){
  const row=document.getElementById('char-row');
  CHARS.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='char-pick';
    el.innerHTML=`
      <img src="${c.photo}" alt="${c.name}">
      <div class="cname">${c.name}</div>
      <div class="ctitle">${c.title}</div>
      <div class="chp-setup">${'â¤ï¸'.repeat(c.maxHp)}</div>
      <div class="cability">ã€${c.ability}ã€‘<br>${c.abilityDesc}</div>
      <button class="pick-btn">é€‰æ‹© âš”ï¸</button>
    `;
    el.querySelector('.pick-btn').addEventListener('click',()=>startGame(i));
    row.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfRaf=null,cfParts=[];
const cfColors=['#FFD700','#FF6B6B','#4CAF50','#29B6F6','#FF80AB','#c9a227','#f5d060'];
function launchConfetti(){
  const c=document.getElementById('cfv');
  c.width=innerWidth;c.height=innerHeight;
  cfParts=Array.from({length:110},()=>({
    x:Math.random()*innerWidth,y:-10,
    vx:(Math.random()-.5)*5,vy:Math.random()*4+2,
    size:Math.random()*8+4,color:cfColors[Math.floor(Math.random()*cfColors.length)],
    rot:Math.random()*360,rv:(Math.random()-.5)*6,
  }));
  (function loop(){
    const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);
    cfParts.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;p.rot+=p.rv;p.vy+=.06;
      ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle=p.color;ctx.fillRect(-p.size/2,-p.size/4,p.size,p.size/2);
      ctx.restore();
    });
    cfParts=cfParts.filter(p=>p.y<c.height+20);
    if(cfParts.length) cfRaf=requestAnimationFrame(loop);
  })();
}
function stopConfetti(){cancelAnimationFrame(cfRaf);cfRaf=null;const c=document.getElementById('cfv');c.getContext('2d').clearRect(0,0,c.width,c.height);}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildSetup();
</script>
</body>
</html>
